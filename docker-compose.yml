version: '2'
services:
  db:
    image: postgres:9.4
    env_file:
      - .env
  nginx:
    build: ./docker/nginx/
    ports:
      - "80:80"
      - "443:443"
    volumes_from:
      - web
    links:
      - web:web
      - flower:flower
  redis:
    image: redis
    ports:
      - "6379:6379"
  web:
    build: .
    env_file:
      - .env
    expose:
      - "8000"
    links:
      - db:db
      - redis:redis
    volumes:
      - .:/code
      - /static/
      - /logs/
    command: bash -c "python manage.py collectstatic --no-input && python manage.py migrate && /usr/local/bin/gunicorn ac_mediator.wsgi:application -w 1 -b :8000 --reload --log-file=/logs/gunicorn.log --access-logfile=/logs/gunicorn-access.log"
    depends_on:
      - db
      - redis
  celery:
    build: .
    env_file:
      - .env
    links:
      - redis:redis
    volumes:
      - .:/code
    command: celery worker -A ac_mediator --concurrency=100
    depends_on:
      - redis
  flower:  #  Django app to monitor Celery status
    build: ./docker/flower/
    env_file:
      - .env
    command: flower --address=0.0.0.0 --port=5555 --broker=redis://redis --url_prefix=flower
    expose:
      - "5555"
    depends_on:
      - celery
    links:
      - db:db
      - redis:redis
  redmon:  #  Redis monitoring
    build: ./docker/redmon/
    command: redmon --port=4567 --redis=redis://redis --base-path=/redmon --secure=${REDMON_BASIC_AUTH}
    expose:
      - "4567"
    depends_on:
      - redis